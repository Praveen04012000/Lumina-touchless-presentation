<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumina | Touchless Presentation Controller</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- Reveal.js Styles -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/reveal.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/theme/black.min.css" id="theme">
    
    <!-- JSZip for PPTX Parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- MediaPipe Hands -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <!-- Reveal.js Script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/reveal.min.js"></script>

    <style>
        :root {
            --primary: #00f3ff;
            --primary-dim: rgba(0, 243, 255, 0.1);
            --accent: #bc13fe;
            --spotlight: #ffee00;
            --bg: #030305;
            --panel: rgba(20, 20, 25, 0.6);
            --border: rgba(255, 255, 255, 0.1);
            --text: #e0e0e0;
            --font-main: 'Inter', sans-serif;
            --font-tech: 'Rajdhani', sans-serif;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg);
            font-family: var(--font-main);
            color: var(--text);
            overflow: hidden;
            user-select: none;
        }

        /* --- AMBIENT BACKGROUND --- */
        .bg-grid {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: 
                linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: 0;
            pointer-events: none;
        }
        
        .scanline {
            width: 100%;
            height: 100%;
            position: absolute;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px;
            z-index: 21; /* Top of UI */
            pointer-events: none;
            opacity: 0.3;
        }

        /* --- LAYOUT LAYERS --- */
        #app-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        /* Layer 1: Presentation (Bottom) */
        #presentation-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
            opacity: 0;
            transition: opacity 1s ease;
        }

        /* Layer 2: Particle Feedback (Middle) */
        #particle-canvas {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        /* Layer 3: UI & Landing (Top) */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* --- LANDING SCREEN --- */
        #landing-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #0a0a0a 0%, #000000 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 30;
            pointer-events: auto;
            transition: transform 0.8s cubic-bezier(0.86, 0, 0.07, 1);
        }

        .brand-container {
            text-align: center;
            margin-bottom: 4rem;
            position: relative;
        }

        .hero-title {
            font-family: var(--font-tech);
            font-size: 6rem;
            font-weight: 700;
            letter-spacing: 10px;
            text-transform: uppercase;
            background: linear-gradient(180deg, #fff 0%, #aaa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
            line-height: 1;
            text-shadow: 0 0 30px rgba(255,255,255,0.2);
        }

        .hero-subtitle {
            font-family: var(--font-tech);
            color: var(--primary);
            font-size: 1.2rem;
            letter-spacing: 4px;
            text-transform: uppercase;
            margin-top: 10px;
            opacity: 0.8;
        }

        .action-container {
            display: flex;
            gap: 40px;
        }

        .action-card {
            width: 320px;
            height: 240px;
            position: relative;
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .action-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 2px;
            background: var(--primary);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }

        .action-card:hover {
            background: rgba(0, 243, 255, 0.05);
            border-color: var(--primary);
            transform: translateY(-5px);
        }

        .action-card:hover::before {
            transform: scaleX(1);
        }

        .upload-icon { font-size: 2.5rem; margin-bottom: 1.5rem; color: var(--primary); }
        .upload-text { font-family: var(--font-tech); font-size: 1.5rem; font-weight: 600; text-transform: uppercase; letter-spacing: 2px; }
        .upload-sub { font-size: 0.85rem; color: #888; margin-top: 0.5rem; font-family: var(--font-main); }

        #camera-preview-status {
            margin-top: 60px;
            text-align: center;
            display: none;
        }
        
        .status-ring {
            width: 80px; height: 80px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            margin: 0 auto 20px;
            animation: spin 1.5s linear infinite;
        }

        @keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }

        /* --- HUD ELEMENTS --- */
        .status-bar {
            width: 100%;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .status-pill {
            background: rgba(10, 10, 12, 0.8);
            border: 1px solid var(--border);
            padding: 10px 30px;
            border-radius: 4px; /* Tech look */
            font-family: var(--font-tech);
            font-size: 1.1rem;
            font-weight: 600;
            letter-spacing: 2px;
            color: var(--primary);
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            position: relative;
        }
        
        /* Corner accents for pill */
        .status-pill::before { content: ''; position: absolute; top: -1px; left: -1px; width: 10px; height: 10px; border-top: 2px solid var(--primary); border-left: 2px solid var(--primary); }
        .status-pill::after { content: ''; position: absolute; bottom: -1px; right: -1px; width: 10px; height: 10px; border-bottom: 2px solid var(--primary); border-right: 2px solid var(--primary); }

        .status-dot {
            width: 8px; height: 8px;
            background-color: var(--primary);
            box-shadow: 0 0 10px var(--primary);
        }

        .gesture-guide {
            position: absolute;
            bottom: 40px;
            left: 40px; 
            display: flex;
            flex-direction: column;
            gap: 15px;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .guide-item {
            display: flex;
            align-items: center;
            gap: 15px;
            font-family: var(--font-tech);
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.6);
            font-size: 0.9rem;
            padding-left: 10px;
            border-left: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .guide-item.active {
            color: var(--primary);
            border-left-color: var(--primary);
            text-shadow: 0 0 10px var(--primary-dim);
        }

        /* VIDEO FEED WRAPPER (Tech Frame) */
        #video-container {
            position: absolute;
            bottom: 40px;
            right: 40px;
            width: 260px;
            height: 195px;
            z-index: 25;
            background: rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.1);
            /* Tech corners */
            clip-path: polygon(
                0 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 
                0 100%, 0 20px, 20px 0
            );
        }
        
        /* Tactical markers on video */
        #video-container::after {
            content: 'LIVE FEED';
            position: absolute;
            bottom: 5px; right: 10px;
            font-family: var(--font-tech);
            font-size: 10px;
            color: var(--primary);
            letter-spacing: 1px;
        }

        #input_video {
            width: 100%; height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            opacity: 0.7;
        }

        #camera-overlay-canvas {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            transform: scaleX(-1);
            pointer-events: none;
        }

        #file-input { display: none; }
        #loading-text { margin-top: 20px; font-family: var(--font-tech); color: var(--primary); letter-spacing: 2px; display: none; text-transform: uppercase; }

        /* --- PRESENTATION STYLING --- */
        .reveal { font-family: var(--font-main); }
        .reveal h1, .reveal h2, .reveal h3 {
            font-family: var(--font-tech);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .reveal h1 { 
            font-weight: 700; 
            font-size: 4rem;
            background: linear-gradient(135deg, #fff, #888);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .reveal p, .reveal li { 
            color: #ccc; 
            font-weight: 300; 
        }

        /* --- DEMO GRAPHICS (CSS ANIMATIONS) --- */
        
        /* Slide 1: Reactor */
        .demo-reactor {
            width: 150px; height: 150px;
            margin: 40px auto;
            position: relative;
        }
        .reactor-ring {
            position: absolute; top:0; left:0; width:100%; height:100%;
            border: 2px solid var(--primary);
            border-radius: 50%;
            border-left-color: transparent;
            border-right-color: transparent;
            animation: spin 4s linear infinite;
        }
        .reactor-core {
            position: absolute; top:20%; left:20%; width:60%; height:60%;
            background: radial-gradient(circle, var(--primary) 0%, transparent 70%);
            border-radius: 50%;
            animation: pulse-glow 2s ease-in-out infinite;
        }

        /* Slide 2: Grid */
        .demo-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 30px;
        }
        .demo-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 20px;
            text-align: left;
        }
        .demo-card h4 { color: var(--primary); margin: 0 0 10px 0; font-family: var(--font-tech); }
        .demo-card small { color: #888; display: block; }

        /* Slide 3: Target */
        .target-reticle {
            width: 200px; height: 200px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            position: relative;
            margin: 40px auto;
            display: flex; align-items: center; justify-content: center;
        }
        .target-cross {
            position: absolute; width: 100%; height: 100%;
        }
        .target-cross::before { content:''; position: absolute; top:50%; left:0; width:100%; height:1px; background: rgba(255,255,255,0.3); }
        .target-cross::after { content:''; position: absolute; left:50%; top:0; height:100%; width:1px; background: rgba(255,255,255,0.3); }
        
        @keyframes pulse-glow { 0% {opacity:0.5; transform:scale(0.9);} 50% {opacity:1; transform:scale(1.1);} 100% {opacity:0.5; transform:scale(0.9);} }

    </style>
</head>
<body>

<div class="bg-grid"></div>
<div class="scanline"></div>

<div id="app-container">
    
    <!-- 1. Video Input & Tracking Overlay -->
    <div id="video-container">
        <video id="input_video" autoplay playsinline></video>
        <canvas id="camera-overlay-canvas"></canvas>
    </div>

    <!-- 2. Landing / Upload Screen -->
    <div id="landing-screen">
        <div class="brand-container">
            <h1 class="hero-title">LUMINA</h1>
            <div class="hero-subtitle">TOUCHLESS INTERFACE SYSTEM V2.0</div>
        </div>
        
        <div class="action-container" id="action-container">
            <!-- Option 1: Upload -->
            <div class="action-card" id="upload-btn">
                <div class="upload-icon">üìÇ</div>
                <div class="upload-text">Initialize Deck</div>
                <div class="upload-sub">IMPORT .PPTX FILE</div>
                <input type="file" id="file-input" accept=".pptx">
            </div>

            <!-- Option 2: Demo -->
            <div class="action-card demo" id="demo-btn">
                <div class="upload-icon">üí†</div>
                <div class="upload-text">Run Simulation</div>
                <div class="upload-sub">LOAD DEMO SEQUENCE</div>
            </div>
        </div>

        <div id="loading-text">Decryption in progress...</div>
        
        <!-- Waiting Prompt -->
        <div id="camera-preview-status">
            <div class="status-ring"></div>
            <div style="font-family: var(--font-tech); font-size: 1.5rem; letter-spacing: 2px; color: var(--primary);">SYSTEM READY</div>
            <div style="font-size: 0.9rem; color: #888; margin-top: 10px;">RAISE OPEN PALM TO ENGAGE</div>
        </div>
    </div>

    <!-- 3. Presentation Layer -->
    <div id="presentation-layer">
        <div class="reveal">
            <div class="slides" id="slides-container">
                <!-- Slides will be injected here -->
            </div>
        </div>
    </div>

    <!-- 4. Particle Feedback Canvas -->
    <canvas id="particle-canvas"></canvas>

    <!-- 5. UI Overlay -->
    <div id="ui-layer">
        <div class="status-bar" id="status-bar">
            <div class="status-pill">
                <div class="status-dot"></div>
                <span id="status-text">SYSTEM OFFLINE</span>
            </div>
        </div>

        <div class="gesture-guide" id="gesture-guide">
            <div class="guide-item" id="guide-start"><div class="guide-icon">üëã</div> ENGAGE</div>
            <div class="guide-item" id="guide-swipe"><div class="guide-icon">‚ÜîÔ∏è</div> NAVIGATE</div>
            <div class="guide-item" id="guide-laser"><div class="guide-icon">‚úåÔ∏è</div> LASER</div>
            <div class="guide-item" id="guide-spot"><div class="guide-icon">üîÑ</div> SPOTLIGHT</div>
        </div>
    </div>

</div>

<script>
/**
 * LUMINA CONTROLLER
 * V2.0 - Futuristic UI Update
 */

// --- CONFIGURATION ---
const CONFIG = {
    camera: { width: 640, height: 480 },
    thresholds: {
        swipeMinDist: 0.1, 
        swipeVelocity: 0.03 
    },
    colors: {
        laser: '#bc13fe',
        swipe: '#00f3ff',
        spotlight: '#ffee00',
    }
};

const State = {
    mode: 'LANDING',
    isLaserActive: false,
    isSpotlightActive: false,
    lastGestureTime: 0,
    handPresent: false,
    handPosition: { x: 0, y: 0 }, 
    history: [], 
    pathHistory: []
};

// --- 1. PPTX PARSER (Images & Text) ---
async function parsePPTX(file) {
    const zip = new JSZip();
    const slidesContent = [];
    
    try {
        const content = await zip.loadAsync(file);
        
        // Find slide files
        const slideFiles = Object.keys(content.files).filter(fileName => 
            fileName.startsWith("ppt/slides/slide") && fileName.endsWith(".xml")
        );
        
        // Sort slides
        slideFiles.sort((a, b) => {
            const numA = parseInt(a.match(/slide(\d+)\.xml/)[1]);
            const numB = parseInt(b.match(/slide(\d+)\.xml/)[1]);
            return numA - numB;
        });

        if (slideFiles.length === 0) throw new Error("No slides found");

        for (const fileName of slideFiles) {
            const xmlText = await content.file(fileName).async("text");
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, "text/xml");

            // --- IMAGE EXTRACTION LOGIC ---
            let slideImagesHtml = "";
            const relsName = fileName.replace("ppt/slides/", "ppt/slides/_rels/") + ".rels";
            const relsFile = content.file(relsName);
            
            if (relsFile) {
                const relsText = await relsFile.async("text");
                const relsDoc = parser.parseFromString(relsText, "text/xml");
                const relationships = relsDoc.getElementsByTagName("Relationship");
                const blips = xmlDoc.getElementsByTagName("a:blip");
                
                for (let i = 0; i < blips.length; i++) {
                    const rEmbed = blips[i].getAttribute("r:embed");
                    for (let j = 0; j < relationships.length; j++) {
                        if (relationships[j].getAttribute("Id") === rEmbed) {
                            let target = relationships[j].getAttribute("Target");
                            target = target.replace("../", "ppt/");
                            const imgFile = content.file(target);
                            if (imgFile) {
                                const imgBlob = await imgFile.async("blob");
                                const imgUrl = URL.createObjectURL(imgBlob);
                                slideImagesHtml += `<img src="${imgUrl}" style="max-height:400px; border:1px solid rgba(255,255,255,0.2); box-shadow: 0 0 20px rgba(0,243,255,0.1);" />`;
                            }
                        }
                    }
                }
            }
            
            // --- TEXT EXTRACTION ---
            const textNodes = xmlDoc.getElementsByTagName("a:t");
            let textArray = [];
            for (let i = 0; i < textNodes.length; i++) {
                const txt = textNodes[i].textContent.trim();
                if(txt) textArray.push(txt);
            }

            // --- LAYOUT BUILDER ---
            let html = "";
            if (textArray.length > 0) {
                html += `<h2>${textArray[0]}</h2>`;
                html += `<div style="display:flex; flex-direction: column; align-items: center; margin-top:20px;">`;
                if (slideImagesHtml) html += `<div>${slideImagesHtml}</div>`;
                if (textArray.length > 1) {
                    html += `<ul style="margin-top:20px; border-left: 2px solid var(--primary); padding-left:20px;">`;
                    for (let i = 1; i < textArray.length; i++) {
                        html += `<li style="margin-bottom:10px;">${textArray[i]}</li>`;
                    }
                    html += `</ul>`;
                }
                html += `</div>`;
            } else {
                html += `<h2>SLIDE DATA</h2>`;
                if (slideImagesHtml) html += slideImagesHtml;
            }
            
            slidesContent.push(`<section>${html}</section>`);
        }

        return slidesContent.join("");

    } catch (e) {
        console.error(e);
        return `<section><h2>DECRYPTION ERROR</h2><p>UNABLE TO PARSE PPTX DATA STREAM.</p></section>`;
    }
}

function loadDemoDeck() {
    return `
        <section>
            <div class="demo-reactor">
                <div class="reactor-ring"></div>
                <div class="reactor-core"></div>
            </div>
            <h1>LUMINA OS</h1>
            <p style="text-align:center; color:var(--primary); font-family:var(--font-tech); letter-spacing:2px;">TOUCHLESS INTERFACE INITIATED</p>
        </section>
        
        <section>
            <h2>GESTURE PROTOCOLS</h2>
            <div class="demo-grid">
                <div class="demo-card">
                    <h4>Open Palm</h4>
                    <small>System Engagement</small>
                </div>
                <div class="demo-card">
                    <h4>Lateral Swipe</h4>
                    <small>Data Navigation</small>
                </div>
                <div class="demo-card">
                    <h4>V-Sign</h4>
                    <small>Laser Pointer</small>
                </div>
                <div class="demo-card">
                    <h4>Circular Motion</h4>
                    <small>Spotlight Focus</small>
                </div>
            </div>
        </section>
        
        <section>
            <h2>TARGET ACQUISITION</h2>
            <div class="target-reticle">
                <div class="target-cross"></div>
                <div style="font-family:var(--font-tech); color:var(--primary);">FOCUS</div>
            </div>
            <p style="text-align:center; font-size:1rem;">EXECUTE CIRCLE GESTURE TO ACTIVATE SPOTLIGHT</p>
        </section>
        
        <section>
            <h2 style="color:var(--primary);">SEQUENCE COMPLETE</h2>
            <p style="text-align:center;">AWAITING FURTHER INPUT...</p>
        </section>
    `;
}


// --- 2. VISUAL ENGINE (PARTICLES) ---
const canvas = document.getElementById('particle-canvas');
const ctx = canvas.getContext('2d');
let particles = [];

function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

class Particle {
    constructor(x, y, type) {
        this.x = x;
        this.y = y;
        this.type = type; 
        this.life = 1.0;
        
        if (type === 'laser') {
            this.vx = (Math.random() - 0.5) * 2;
            this.vy = (Math.random() - 0.5) * 2;
            this.color = CONFIG.colors.laser;
            this.size = Math.random() * 4 + 2;
            this.decay = 0.05;
        } else if (type === 'swipe') {
            this.vx = (Math.random() - 0.5) * 20; 
            this.vy = (Math.random() - 0.5) * 5;
            this.color = CONFIG.colors.swipe;
            this.size = Math.random() * 3 + 1;
            this.decay = 0.02;
        } else if (type === 'spotlight') {
            this.vx = (Math.random() - 0.5) * 10;
            this.vy = (Math.random() - 0.5) * 10;
            this.color = CONFIG.colors.spotlight;
            this.size = Math.random() * 5 + 2;
            this.decay = 0.03;
        }
    }

    update() {
        this.x += this.vx;
        this.y += this.vy;
        this.life -= this.decay;
        this.size *= 0.95;
    }

    draw(ctx) {
        ctx.globalAlpha = Math.max(0, this.life);
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1.0;
    }
}

function spawnParticles(x, y, count, type) {
    for(let i=0; i<count; i++) {
        particles.push(new Particle(x, y, type));
    }
}

function renderLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // --- SPOTLIGHT LAYER ---
    if (State.isSpotlightActive) {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.92)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.globalCompositeOperation = 'destination-out';
        ctx.beginPath();
        const spotX = (1 - State.handPosition.x) * canvas.width;
        const spotY = State.handPosition.y * canvas.height;
        ctx.arc(spotX, spotY, 180, 0, Math.PI * 2); 
        ctx.fill();
        
        ctx.globalCompositeOperation = 'source-over';
        
        ctx.strokeStyle = CONFIG.colors.spotlight;
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]); // Tech look
        ctx.beginPath();
        ctx.arc(spotX, spotY, 180, 0, Math.PI * 2);
        ctx.stroke();
        ctx.setLineDash([]);
    }

    // --- GESTURE TRAIL ---
    if (State.pathHistory.length > 2) {
        ctx.beginPath();
        ctx.strokeStyle = CONFIG.colors.spotlight;
        ctx.lineWidth = 2;
        for (let i = 0; i < State.pathHistory.length; i++) {
            const p = State.pathHistory[i];
            const px = (1 - p.x) * canvas.width;
            const py = p.y * canvas.height;
            if (i === 0) ctx.moveTo(px, py);
            else ctx.lineTo(px, py);
        }
        ctx.stroke();
    }

    // --- LASER ---
    if (State.isLaserActive && State.handPresent) {
        const screenX = (1 - State.handPosition.x) * canvas.width; 
        const screenY = State.handPosition.y * canvas.height;
        spawnParticles(screenX, screenY, 2, 'laser');
        
        ctx.beginPath();
        ctx.fillStyle = CONFIG.colors.laser;
        ctx.shadowBlur = 10;
        ctx.shadowColor = CONFIG.colors.laser;
        ctx.arc(screenX, screenY, 8, 0, Math.PI*2);
        ctx.fill();
        ctx.shadowBlur = 0;
    }

    // --- PARTICLES ---
    for (let i = particles.length - 1; i >= 0; i--) {
        particles[i].update();
        particles[i].draw(ctx);
        if (particles[i].life <= 0) particles.splice(i, 1);
    }

    requestAnimationFrame(renderLoop);
}
renderLoop();


// --- 3. LOGIC & TRANSITIONS ---
const videoElement = document.getElementById('input_video');
const cameraCanvas = document.getElementById('camera-overlay-canvas');
const cameraCtx = cameraCanvas.getContext('2d');

function transitionToPresentation() {
    const layer = document.getElementById('presentation-layer');
    const landing = document.getElementById('landing-screen');
    const status = document.getElementById('status-bar');
    const guide = document.getElementById('gesture-guide');

    landing.style.transform = "translateY(-100%)";
    layer.style.opacity = "1";
    status.style.opacity = "1";
    guide.style.opacity = "1";
    State.mode = 'PRESENTING';
    updateStatus("ACTIVE");
    highlightGuide('start');
}

function updateStatus(text) {
    const el = document.getElementById('status-text');
    const dot = document.querySelector('.status-dot');
    el.innerText = text;
    
    // Reset guide highlights
    document.querySelectorAll('.guide-item').forEach(el => el.classList.remove('active'));

    if (text === "LASER ACTIVE") {
        dot.style.backgroundColor = CONFIG.colors.laser;
        highlightGuide('laser');
    }
    else if (text === "SPOTLIGHT") {
        dot.style.backgroundColor = CONFIG.colors.spotlight;
        highlightGuide('spot');
    }
    else if (text.includes("SLIDE")) {
        highlightGuide('swipe');
        dot.style.backgroundColor = CONFIG.colors.swipe;
    }
    else {
        dot.style.backgroundColor = CONFIG.colors.swipe;
    }
}

function highlightGuide(id) {
    const el = document.getElementById('guide-'+id);
    if(el) el.classList.add('active');
}

function toggleSpotlight() {
    State.isSpotlightActive = !State.isSpotlightActive;
    if (State.isSpotlightActive) {
        updateStatus("SPOTLIGHT");
        spawnParticles(canvas.width/2, canvas.height/2, 50, 'spotlight');
    } else {
        updateStatus("ACTIVE");
    }
}

// --- GESTURE DETECTION ---
function dist(p1, p2) { return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2)); }

function detectGesture(landmarks) {
    const now = Date.now();
    if (now - State.lastGestureTime < 500) return; 

    const wrist = landmarks[0];
    const indexTip = landmarks[8];
    const extendedCount = [4,8,12,16,20].filter(i => dist(landmarks[i], wrist) > 0.25).length;

    // 1. START
    if (State.mode === 'WAITING_START' && extendedCount === 5) {
        transitionToPresentation();
        spawnParticles(canvas.width/2, canvas.height/2, 50, 'swipe');
        State.lastGestureTime = now;
        return;
    }

    if (State.mode !== 'PRESENTING') return;

    // 2. LASER
    const isLaser = extendedCount === 2 && dist(indexTip, wrist) > 0.3;
    if (isLaser && !State.isSpotlightActive) {
        State.isLaserActive = true;
        State.handPosition = indexTip;
        State.pathHistory = [];
        updateStatus("LASER ACTIVE");
        return; 
    } else {
        State.isLaserActive = false;
        if (!State.isSpotlightActive) updateStatus("ACTIVE");
    }

    // 3. SPOTLIGHT
    if (extendedCount === 1) { 
        State.pathHistory.push({x: indexTip.x, y: indexTip.y});
        if (State.pathHistory.length > 50) State.pathHistory.shift();

        if (State.pathHistory.length >= 25) {
            const start = State.pathHistory[0];
            const end = State.pathHistory[State.pathHistory.length-1];
            
            if (dist(start, end) < 0.3) {
                let minX=1, maxX=0, minY=1, maxY=0;
                State.pathHistory.forEach(p => { 
                    if(p.x<minX)minX=p.x; if(p.x>maxX)maxX=p.x; 
                    if(p.y<minY)minY=p.y; if(p.y>maxY)maxY=p.y;
                });
                
                const width = maxX - minX;
                const height = maxY - minY;
                
                if (width > 0.1 && height > 0.1) {
                    toggleSpotlight(); 
                    State.pathHistory = []; 
                    State.lastGestureTime = now + 1500; 
                    return;
                }
            }
        }
    } else {
        State.pathHistory = [];
    }

    // 4. SWIPE
    if (State.history.length > 6 && !State.isSpotlightActive) {
        const start = State.history[0];
        const end = State.history[State.history.length-1];
        const dx = end.x - start.x; 

        if (Math.abs(dx) > CONFIG.thresholds.swipeMinDist) {
            const center = {x: canvas.width/2, y: canvas.height/2};
            if (dx > 0) { 
                Reveal.next();
                spawnParticles(center.x, center.y, 60, 'swipe');
                updateStatus("NEXT SLIDE");
            } else { 
                Reveal.prev();
                spawnParticles(center.x, center.y, 60, 'swipe');
                updateStatus("PREVIOUS SLIDE");
            }
            State.lastGestureTime = now;
            State.history = [];
        }
    }
}

// --- MEDIAPIPE ---
const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6});

hands.onResults((results) => {
    cameraCtx.clearRect(0, 0, cameraCanvas.width, cameraCanvas.height);

    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        State.handPresent = true;
        const landmarks = results.multiHandLandmarks[0];
        
        // Skeleton Overlay
        drawConnectors(cameraCtx, landmarks, HAND_CONNECTIONS, {color: 'rgba(0, 243, 255, 0.8)', lineWidth: 2});
        drawLandmarks(cameraCtx, landmarks, {color: '#bc13fe', lineWidth: 1, radius: 2});

        State.history.push({x: landmarks[0].x, y: landmarks[0].y});
        if (State.history.length > 10) State.history.shift();
        
        if (landmarks[8]) State.handPosition = landmarks[8];
        
        detectGesture(landmarks);
    } else {
        State.handPresent = false;
        State.isLaserActive = false;
        if(State.mode === 'PRESENTING') updateStatus("NO SIGNAL");
    }
});

let isRevealInitialized = false;

async function startSystem(htmlContent) {
    document.getElementById('action-container').style.display = 'none';
    document.getElementById('loading-text').style.display = 'block';
    
    document.getElementById('slides-container').innerHTML = htmlContent;
    
    if (isRevealInitialized) {
        Reveal.sync();
        Reveal.slide(0);
    } else {
        await Reveal.initialize({
            controls: false, 
            progress: true, 
            center: true, 
            hash: false, 
            transition: 'convex',
            backgroundTransition: 'zoom'
        });
        isRevealInitialized = true;
    }

    document.getElementById('loading-text').innerText = "ESTABLISHING NEURAL LINK...";
    
    const vidContainer = document.getElementById('video-container');
    cameraCanvas.width = 260; 
    cameraCanvas.height = 195; 

    const camera = new Camera(videoElement, {
        onFrame: async () => { await hands.send({image: videoElement}); },
        width: 640, height: 480
    });
    await camera.start();

    document.getElementById('loading-text').style.display = 'none';
    document.getElementById('camera-preview-status').style.display = 'block';
    State.mode = 'WAITING_START';
}

const uploadBtn = document.getElementById('upload-btn');
const demoBtn = document.getElementById('demo-btn');
const fileInput = document.getElementById('file-input');

uploadBtn.addEventListener('click', () => fileInput.click());
demoBtn.addEventListener('click', () => startSystem(loadDemoDeck()));

fileInput.addEventListener('change', async (evt) => {
    const file = evt.target.files[0];
    if (!file) return;
    
    document.getElementById('loading-text').innerText = "DECRYPTING DATA STREAM...";
    document.getElementById('loading-text').style.display = 'block';
    document.getElementById('action-container').style.display = 'none';

    const slideHtml = await parsePPTX(file);
    startSystem(slideHtml);
});

</script>
</body>
</html>
